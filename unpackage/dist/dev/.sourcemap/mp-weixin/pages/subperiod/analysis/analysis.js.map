{"version":3,"sources":["uni-app:///main.js","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?9265","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?ab06","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?be34","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?f4c2","uni-app:///pages/subperiod/analysis/analysis.vue","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?bd0c","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/analysis/analysis.vue?8bcc"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","cycleLength","periodLength","lutealDays","y","m","d","store","date","weight","start","end","lastEnd","lastLen","prevLen","lastStart","endD","deltaText","items","dateLabel","status","lenText","len","isCurrent","added","it","rangeText","lastLenText","normalTag","stdev","text","lens","nextStart","ovulationDay","fertileStart","fertileEnd","fertileRangeText","levelOrder","Object","list","_date","painSummaryText","painLevelText","painPeakText","entries","counts","peakRank","peakLv","commonCnt","commonLv","filter","map","total","sexDates","fertile","summary","unprotected","missMethod","period","ovulation","other","out","risk","data","hasData","latestStart","latestEnd","latestPeriodLen","latestCycleLen","stabilityText","confidenceText","cycleChange","sexSummaryText","sexFertileText","sexUnprotectedText","sexPrevSummaryText","sexPrevFertileText","sexPrevUnprotectedText","sexCycleTotal","sexPregRateText","sexPhaseBars","weight7SubText","latest7WeightText","weightHintText","canvasW","canvasH","canvasCssW","canvasCssH","dpr","onLoad","onShow","methods","onGoWeight","uni","fail","title","icon","onGoLove","url","refresh","thisCycleEnd","pred","prevPhaseCounts","prevStart","prevEnd","prevPeriodEnd","prevPred","label","cur","prev","curPct","prevPct","buildWeight7Series","days","labels","latestVal","subText","latestText","hintText","values","measureCanvasAndDraw","in","select","boundingClientRect","exec","drawWeight7Canvas","ctx","xs","tx","started"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,iBAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAqH;AACrH;AAC4D;AACL;AACa;;;AAGpE;AACqL;AACrL,gBAAgB,yLAAU;AAC1B,EAAE,8EAAM;AACR,EAAE,mFAAM;AACR,EAAE,4FAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,uFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACvBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACRA;AAAA;AAAA;AAAA;AAA+rB,CAAgB,8qBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AC2LntB;AACA;EAAAC;EAAAC;EAAAC;AAAA;AAEA;EAAA;AAAA;AACA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;IAAAC;IAAAC;IAAAC;EAAA;AAAA;AACA;EACA;EAAA;EACA;EACA;AACA;AACA;EAAA;AAAA;AACA;EAAA;AAAA;AACA;EACA;EACA;AACA;AACA;EACAC;EACAA;EACAA;EACAA;EACAA;EACAA;;EAIA;EACAA;EACA;IACA;IACAA;MACA;MACA;MACA;QAAAC;QAAAC;MAAA;IACA;MAAA;IAAA;EACA;EACA;IACAF;MACA;MACA;MACA;MACA;QAAAC;QAAAC;MAAA;IACA;MAAA;IAAA;IACAF;MAAA;IAAA;EACA;EAEA;IACA;IACAA;MAAA;QAAAG;QAAAC;MAAA;IAAA;EACA;EACAJ;IAAA;EAAA;EACA;AACA;AACA;EACA;EACA;AACA;AACA;EACA;EACA;EACA;AACA;AACA;EAAA;AAAA;AACA;EACA;EACA;EACAD;EACA;AACA;AACA;EAAA;AAAA;AAEA;EACA;EAEA;IAAA;EAAA;EACA;EAEA;EACA;EACA;EAEA;IAAAM;IAAAC;IAAAC;EACA;IACAC;IACA;IACAF;IACA;IAAAG;IACAJ;EACA;EACA;IACA;IACA;IACAE;EACA;EAEA;EACA;EACA;IACA;IACAG;EACA;EAEA;EACA;EACAC;IACAC;IACAC;IACAC;IACAC;IACAC;EACA;EAEA;EACA;IACA;IACA;IACA;IACA;IACA;IACA;IACA,sEACA;IACAL;MAAAC;MAAAC;MAAAC;MAAAC;MAAAC;IAAA;IACAC;EACA;;EAEA;AACA;AACA;AACA;EACA;EAEAN;IACA;IACA;IACAO;IACAA;EACA;EAEA;EACA;IAAAC;IAAAC;IAAAC;IAAAX;IAAAC;EAAA;AACA;AAEA;EACA;EACA;IAAAW;IAAAC;EAAA;EACA;EACA;IAAAC;EAAA;EACA;IAAA;EAAA;EACA;IAAA;EAAA;EACA;EACA;EACA,kCACA;EACA;IAAAF;IAAAC;EAAA;AACA;AACA;EACA;EACA;EACA;IACA;IACAnB;EACA;EACA;IAAAD;IAAAC;EAAA;AACA;AACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;EACA;IAAAqB;IAAAC;IAAAC;IAAAC;IAAAC;EAAA;AACA;;AAEA;AACA;EACA;EACA;AACA;;AAEA;EACA;EACA;EACA;EACAC;IAAA;EAAA;EAEA;EACAC;IACA;IACA;IACAC;MAAA;QAAAC;MAAA;IAAA;EACA;EAEA;EACA;IACA;MACAC;MACAC;MACAC;IACA;EACA;;EAEA;EACA;EACA;EACA;EAEAC;IACA;IACAC;IAEA;IACA;MACAC;MACAC;IACA;EACA;;EAEA;EACA;EACA;EACAT;IACA;MACAU;MACAC;IACA;EACA;;EAEA;EACA,2BACAC;IAAA;EAAA,GACAC;IAAA;EAAA;EACA;EAEA;IACAV;IACAC;IACAC;EACA;AACA;;AAGA;AACA;EACA;EACA;EAEA;IAAA;EAAA;EACA;EAEA;EACA;EACA;;EAEA;EACAL;IACA;IACA;IACAc;IAEAb;MACA;MACA;MACA;IACA;EACA;;EAEA;EACAc;IACA;IACA;IACA;EACA;;EAEA;EACA;EACA;IACA;IACA;IAEAf;MACA;MACA;MACAgB;IACA;IAEAD;MACA;MACA;MACA;IACA;EACA;EAEA;EAEA;IACAE;IACAD;IACAE,2BACA,aACAC;EACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;EACA;EACA;EACA;EAEA;IAAA;EAAA;EACA;IACA;IACA;IACA;EACA;EAEA;IACAC;MAAAN;MAAAI;IAAA;IACAG;MAAAP;MAAAI;IAAA;IACAI;MAAAR;MAAAI;IAAA;EACA;;EAEA;EACAlB;IACA;IACA;IACA;IAEA;IACAuB;IAEAtB;MACA;MACA;IACA;EACA;;EAEA;EACAc;IACA;IACA;IACA;IACA;IACAQ;IACAA;EACA;EAEA;AACA;;AAEA;AACA;EACA;EACA;IAAAT;IAAAI;EAAA;EACA;IAAAJ;IAAAI;EAAA;EACA;IAAAJ;IAAAI;EAAA;EAEA;EACA;EAEA;EACAM;EACAA;EACAA;EAEA;AACA;AAAA,eAGA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MACAtC;MACAC;MACAG;MACAmC;MACA9B;MACAC;MACAC;MAEA;MACA6B;MACAC;MACAC;MACA;MACAC;MACAC;MACAC;MACA;MACAC;MACAC;MACA;MACAC;MAGA;MACAC;MACAC;MACAC;MAEA;MACAC;MACAC;MACAC;MACAC;MACAC;IACA;EACA;EACAC;IAAA;EAAA;EACAC;IAAA;EAAA;EACAC;IACAC;MACAC;QACA;QACAC;UAAA;YAAAC;YAAAC;UAAA;QAAA;MACA;IACA;IAEAC;MACAJ;QACAK;QACA;MACA;IACA;IAEAC;MAAA;MACA;MACA;MACA;;MAEA;MACA;MACA;QACAlB;QACAC;QACAC;MACA;MACA;QAAA;MAAA;;MAEA;MACA;QACA;UACAnB;UACAC;UACAC;UACAC;UACAC;UACAC;UACAC;UACAtC;UACAC;UACAG;UACAmC;UACA9B;UACAC;UACAC;UACA6B;UACAC;UACAC;UACAC;UACAC;UACAC;UAEAC;UACAC;UACAC;QAGA;QACA;MACA;MAEA;MACA;MACA;MACA;MACA;MAEA;MACA;MACA;MAEA;MACA;MACA;MAEA;MACA;;MAEA;MACA;MACA;;MAEA;MACA;QAAAzB;QAAAD;QAAAE;MAAA;;MAEA;MACA;MACA,yCACAjD,OACA0D,aACAmC,cACAnC,aACAC,WACAmC,mBACAA,gBACA;;MAEA;MACA;QACA3C;UAAAN;UAAAI;QAAA;QACAG;UAAAP;UAAAI;QAAA;QACAI;UAAAR;UAAAI;QAAA;MACA;MACA;QAAA;MAAA;MACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QAEA8C,sCACA/F,OACAgG,WACAC,SACAD,WACAE,eACAC,uBACAA,oBACA;MACA;;MAEA;MACA,aACA;QAAAC;QAAAC;QAAAC;MAAA,GACA;QAAAF;QAAAC;QAAAC;MAAA,GACA;QAAAF;QAAAC;QAAAC;MAAA,EACA;MACA;QAAA;MAAA;QAAA;MAAA;MACA;MAEA;QACA;QACA;QACA;QACA;QACA;QACA;UAAAC;UAAAC;QAAA;MACA;MAEA;QAAA;MAAA;MACA;MACA;;MAGA;MACA;MACA;MACA;MACA;MACA;MACA;;MAEA;MACA;MACA;MACA;MACA;MACA;MACA;;MAEA;;MAGA;;MAEA;MACA;MACA;MACA;;MAEA;MACA;MACA;MACA;MACA;MAEA;QACA/C;QACAC;QACAC;QACAC;QACAC;QACAC;QACAC;QACAtC;QACAC;QACAG;QACAmC;QACA9B;QACAC;QACAC;QACA;QACA;QACA;QACA6B;QACAC;QACAC;QAEAC;QACAC;QACAC;QAEAC;QACAC;QACAC;MAEA;IACA;IAEA;IACAgC;MACA;MACA;MACA;MACA;QACA;QACA1G;QACA;QACA2G;QACAC;MACA;MAEA;MACA;QACA;QACA;QACA/D;MACA;MAEA;QAAA;MAAA;MACA;QAAA;MAAA;MAEA;MACA;MACA,0DACA;QACA;UACA;UACA;YAAAgE;YAAA;UAAA;QACA;MACA;MAEA;MACA;MACA;MAEA;QACA;QACA;QACA;QACAC;QACAC;QACAC;MACA;MAEA;QAAAJ;QAAAK;QAAAH;QAAAC;QAAAC;MAAA;IACA;IAEA;IACAE;MAAA;MACA3B,0BACA4B,SACAC,yBACAC;QACA;QAEA;QACA;QAEA,eACA;UAAAvC;UAAAC;UAAAC;UAAAC;UAAAC;QAAA,GACA;UAAA;QAAA,EACA;MACA,GACAoC;IACA;IAEAC;MACA;MAEA;MACA;MAEAC;;MAEA;MACA;MACA;MACA;MACA;;MAEA;MACA;;MAEA;MACAA;MACAA;MACA;QACA;QACAA;QACAA;QACAA;QACAA;MACA;;MAEA;MACA;MACA;QAAAC;MAAA;MAEA;MACA;;MAEA;MACAD;MACAA;MACA;QACA;QACA;QAEA;QACA;;QAEA;QACAE;;QAEA;QACAF;MACA;MAEA;QAAA;MAAA;MACA;QACAA;QACA;MACA;MAEA;MACA;MACA;MAEA;QACA;QACA;QACA;MACA;;MAEA;MACAA;MACAA;MACA;MAEAP;QACA;UACA;UACAU;UACA;QACA;QACA;QACA;QACA;UACAH;UACAA;UACAG;QACA;UACAH;QACA;MACA;MACA;;MAEA;MACA;MACAA;;MAEA;MACA;MACA;MACAA;MACAA;MAEAP;QACA;QAEA;QACA;;QAEA;QACAO;QACAA;QACAA;QACAA;;QAEA;QACAA;QAEA;QACA;QACA;;QAEA;QACAE;;QAEA;QACA;QACA;QACA;QAEAF;MACA;MAEAA;IACA;EAEA;AACA;AAAA,2B;;;;;;;;;;;;;ACtgCA;AAAA;AAAA;AAAA;AAAs/B,CAAgB,27BAAG,EAAC,C;;;;;;;;;;;ACA1gC;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/subperiod/analysis/analysis.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/subperiod/analysis/analysis.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./analysis.vue?vue&type=template&id=e8232890&\"\nvar renderjs\nimport script from \"./analysis.vue?vue&type=script&lang=js&\"\nexport * from \"./analysis.vue?vue&type=script&lang=js&\"\nimport style0 from \"./analysis.vue?vue&type=style&index=0&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/subperiod/analysis/analysis.vue\"\nexport default component.exports","export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./analysis.vue?vue&type=template&id=e8232890&\"","var components\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./analysis.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./analysis.vue?vue&type=script&lang=js&\"","<template>\n  <view class=\"page\">\n   <!-- <view class=\"card\">\n      <view class=\"header\">\n        <text class=\"title\">经期健康分析</text>\n      </view>\r\n\t  <view class=\"header\">\r\n\t    <text class=\"sub\" v-if=\"hasData\">基于已有记录生成（仅供参考）</text>\r\n\t    <text class=\"sub\" v-else>暂无经期记录，先在日历里记录“月经来了”再回来看看</text>\r\n\t  </view>\n    </view> -->\n\n    <view v-if=\"hasData\">\n      <!-- 1) 本周期概览 -->\n\t  <view class=\"card\">\r\n\t    <view class=\"card-title\">\r\n\t      <image class=\"card-title-icon\" src=\"/static/assets/icons/f_gl.svg\" mode=\"aspectFit\" />\r\n\t      <text class=\"card-title-text\">本周期概览</text>\r\n\t    </view>\r\n\t  \r\n\t    <view class=\"kv\">\r\n\t      <text class=\"k\">最近经期</text>\r\n\t      <text class=\"v\">{{ latestStart }} ~ {{ latestEnd }}</text>\r\n\t    </view>\r\n\t    <view class=\"kv\">\r\n\t      <text class=\"k\">经期长度</text>\r\n\t      <text class=\"v\">{{ latestPeriodLen }} 天</text>\r\n\t    </view>\r\n\t    <view class=\"kv\">\r\n\t      <text class=\"k\">周期长度</text>\r\n\t      <text class=\"v\">{{ latestCycleLen }} 天</text>\r\n\t    </view>\r\n\t    <view class=\"kv\">\r\n\t      <text class=\"k\">周期稳定性</text>\r\n\t      <text class=\"v\">{{ stabilityText }}</text>\r\n\t    </view>\r\n\t    <view class=\"kv\">\r\n\t      <text class=\"k\">预测可信度</text>\r\n\t      <text class=\"v\">{{ confidenceText }}</text>\r\n\t    </view>\r\n\t  </view>\r\n\n\n      <!-- 2) 预测信息 -->\n<!--      <view class=\"card\">\n        <view class=\"card-title\">预测与排卵期</view>\n        <view class=\"kv\">\n          <text class=\"k\">下次预计开始</text>\n          <text class=\"v\">{{ nextStart || '数据不足' }}</text>\n        </view>\n        <view class=\"kv\">\n          <text class=\"k\">排卵日（推算）</text>\n          <text class=\"v\">{{ ovulationDay || '数据不足' }}</text>\n        </view>\n        <view class=\"kv\">\n          <text class=\"k\">排卵期范围</text>\n          <text class=\"v\">{{ fertileRangeText || '数据不足' }}</text>\n        </view>\n      </view> -->\n\n      <!-- 3) 周期变化 -->\n      <view class=\"card\" v-if=\"cycleChange\">\n        <view class=\"cycle-head\">\n          <view class=\"cycle-head-left\">\n            <image class=\"cycle-icon\" src=\"/static/assets/icons/f_rq.svg\" mode=\"aspectFit\" />\n            <text class=\"cycle-title\">周期变化</text>\n          </view>\n          <!-- <image class=\"cycle-arrow\" src=\"/static/assets/icons/f_tz.svg\" mode=\"aspectFit\" /> -->\n        </view>\n\n        <view class=\"cycle-sub\">{{ cycleChange.rangeText }}</view>\n\n        <view class=\"cycle-summary\">\n          <view class=\"cycle-summary-left\">\n            <view class=\"cycle-label\">周期天数</view>\n            <view class=\"cycle-big\">\n              <text class=\"cycle-num\">{{ cycleChange.lastLenText }}</text>\n              <text class=\"cycle-tag\">{{ cycleChange.normalTag }}</text>\n            </view>\n          </view>\n\n          <view class=\"cycle-summary-right\">\n            <view class=\"cycle-label\">比前 1 个周期</view>\n            <view class=\"cycle-delta\">{{ cycleChange.deltaText }}</view>\n          </view>\n        </view>\n\n        <view class=\"cycle-list-title\">近期周期天数</view>\n\n        <view class=\"cycle-list\">\n          <view class=\"cycle-item\" v-for=\"(item, index) in cycleChange.items\" :key=\"index\">\n            <view class=\"cycle-item-left\">\n              <text class=\"cycle-date\">{{ item.dateLabel }}</text>\n              <text class=\"cycle-status\">{{ item.status }}</text>\n            </view>\n\n            <!-- ✅ 文字不放在粉色条里，避免被裁剪 -->\n            <view class=\"cycle-bar-wrap\">\n              <view class=\"cycle-bar\" :style=\"item.barStyle\"></view>\n              <text class=\"cycle-bar-text-fixed\">{{ item.lenText }}</text>\n            </view>\n          </view>\n        </view>\n      </view>\n\n      <!-- 4) 痛经 -->\n      <view class=\"card\">\n        <!-- <view class=\"card-title\">痛经情况</view> -->\r\n\t\t<view class=\"card-title\">\r\n\t\t  <image class=\"card-title-icon\" src=\"/static/assets/icons/f_t.svg\" mode=\"aspectFit\" />\r\n\t\t  <text class=\"card-title-text\">痛经情况</text>\r\n\t\t</view>\r\n\t\t\n        <view class=\"p\">{{ painSummaryText }}</view>\n        <view class=\"p\">{{ painLevelText }}</view>\n        <view class=\"p\">{{ painPeakText }}</view>\n      </view>\n\n      <!-- 5) 行为 -->\r\n      <view class=\"card\">\r\n        <view class=\"card-title card-title--with-right\" @tap=\"onGoLove()\">\r\n          <view class=\"card-title-left\">\r\n            <image class=\"card-title-icon\" src=\"/static/assets/icons/f_sax.svg\" mode=\"aspectFit\" />\r\n            <text class=\"card-title-text\">行为与风险提示</text>\r\n          </view>\r\n          <image class=\"card-title-right-icon\" src=\"/static/assets/icons/f_tz.svg\" mode=\"aspectFit\" />\r\n        </view>\r\n      \r\n        <!-- 顶部一行：本周期次数 + 怀孕几率 -->\r\n        <view class=\"sex-topline\">\r\n          <view class=\"sex-topitem\">\r\n            <text class=\"sex-toplabel\">本周期爱爱</text>\r\n            <text class=\"sex-topvalue\">{{ sexCycleTotal }}</text>\r\n            <text class=\"sex-topunit\">次</text>\r\n          </view>\r\n          <!-- <view class=\"sex-topitem\">\r\n            <text class=\"sex-toplabel\">怀孕几率</text>\r\n            <text class=\"sex-topvalue\">{{ sexPregRateText }}</text>\r\n          </view> -->\r\n        </view>\r\n      \r\n        <!-- 双柱状图：粉色=本周期，灰色=上周期 -->\r\n        <view class=\"sex-chart\">\r\n          <view class=\"sex-group\" v-for=\"(it, idx) in sexPhaseBars\" :key=\"idx\">\r\n            <view class=\"sex-cols\">\r\n              <view class=\"sex-col\">\r\n                <text class=\"sex-num\">{{ it.cur }}</text>\r\n                <view class=\"sex-bar sex-bar--cur\" :style=\"'height:' + it.curPct + '%'\"></view>\r\n              </view>\r\n              <view class=\"sex-col\">\r\n                <text class=\"sex-num\">{{ it.prev }}</text>\r\n                <view class=\"sex-bar sex-bar--prev\" :style=\"'height:' + it.prevPct + '%'\"></view>\r\n              </view>\r\n            </view>\r\n            <text class=\"sex-xlabel\">{{ it.label }}</text>\r\n          </view>\r\n        </view>\r\n      </view>\r\n\n    </view>\n\n    <!-- 6) 体重趋势：无论是否记录月经，都显示；保留跳转 -->\n    <view class=\"card weight-card\">\n      <view class=\"weight-head\" @tap=\"onGoWeight\">\n        <view class=\"weight-head-left\">\n          <image class=\"weight-icon\" src=\"/static/assets/icons/f_tzc.svg\" mode=\"aspectFit\" />\n          <text class=\"weight-title\">体重趋势（最近7天）</text>\n        </view>\n        <image class=\"weight-arrow\" src=\"/static/assets/icons/f_tz.svg\" mode=\"aspectFit\" />\n      </view>\n\n      <view class=\"weight-sub\">{{ weight7SubText }}</view>\n\n      <canvas\n        class=\"weight-canvas\"\n        id=\"weight7Canvas\"\n        canvas-id=\"weight7Canvas\"\n        :width=\"canvasW\"\n        :height=\"canvasH\"\n      ></canvas>\n\n      <view class=\"p weight-hint\">{{ weightHintText }}</view>\n    </view>\n  </view>\n</template>\n\n<script>\nconst STORE_KEY = 'period_record_v1';\nconst DEFAULTS = { cycleLength: 28, periodLength: 5, lutealDays: 14 };\n\nfunction pad2(n) { return (n < 10 ? '0' : '') + n; }\nfunction toDateStr(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }\nfunction parseDateStr(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); }\nfunction diffDays(aStr, bStr) {\n  const a = parseDateStr(aStr); const b = parseDateStr(bStr);\n  if (!a || !b) return 0;\n  return Math.round((b - a) / 86400000);\n}\nfunction clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }\nfunction fmt2(x) { return (typeof x === 'number' && !Number.isNaN(x)) ? x.toFixed(2) : ''; }\nfunction loadStore() {\n  const v = uni.getStorageSync(STORE_KEY);\n  return v && typeof v === 'object' ? v : {};\n}\nfunction normalizeStore(store) {\n  store.settings = store.settings || { ...DEFAULTS };\n  store.periodRecords = Array.isArray(store.periodRecords) ? store.periodRecords : [];\n  store.periodStarts = Array.isArray(store.periodStarts) ? store.periodStarts : [];\n  store.painRecords = (store.painRecords && typeof store.painRecords === 'object' && !Array.isArray(store.painRecords)) ? store.painRecords : {};\r\n  store.sexRecords  = (store.sexRecords  && typeof store.sexRecords  === 'object' && !Array.isArray(store.sexRecords))  ? store.sexRecords  : {};\r\n  store.sexDates = Array.isArray(store.sexDates) ? store.sexDates : [];\r\n\r\n\n\n  // weightRecords：兼容 Map / Array => [{date, weight}]\n  store.weightRecords = store.weightRecords || [];\n  if (!Array.isArray(store.weightRecords) && typeof store.weightRecords === 'object') {\n    const obj = store.weightRecords;\n    store.weightRecords = Object.keys(obj).sort().map((date) => {\n      const v = obj[date] || {};\n      const w = typeof v.weight === 'number' ? v.weight : (typeof v.kg === 'number' ? v.kg : NaN);\n      return { date, weight: w };\n    }).filter(x => x.date);\n  }\n  if (Array.isArray(store.weightRecords)) {\n    store.weightRecords = store.weightRecords.map((r) => {\n      if (!r) return null;\n      const date = r.date || r.day || r.dateStr;\n      const w = typeof r.weight === 'number' ? r.weight : (typeof r.kg === 'number' ? r.kg : NaN);\n      return { date, weight: w };\n    }).filter(x => x && x.date);\n    store.weightRecords.sort((a, b) => (a.date || '').localeCompare(b.date || ''));\n  }\n\n  if (store.periodRecords.length === 0 && store.periodStarts.length > 0) {\n    const starts = [...store.periodStarts].sort();\n    store.periodRecords = starts.map((s) => ({ start: s, end: s }));\n  }\n  store.periodRecords.sort((a, b) => (a.start || '').localeCompare(b.start || ''));\n  return store;\n}\nfunction getRecentRecords(recordsAsc, n) {\n  const arr = Array.isArray(recordsAsc) ? recordsAsc : [];\n  return arr.length <= n ? arr.slice() : arr.slice(arr.length - n);\n}\nfunction formatMonthDayCN(dateStr) {\n  const d = parseDateStr(dateStr);\n  if (!d) return '';\n  return `${d.getMonth() + 1}月${d.getDate()}日`;\n}\nfunction getTodayStr() { return toDateStr(new Date()); }\nfunction addDaysStr(dateStr, days) {\n  const d = parseDateStr(dateStr);\n  if (!d) return '';\n  d.setDate(d.getDate() + days);\n  return toDateStr(d);\n}\nfunction formatRangeCN(a, b) { return a && b ? `${a} ~ ${b}` : ''; }\n\nfunction buildCycleChangeCard(recordsAsc, settings) {\n  const expected = (settings && settings.cycleLength) ? settings.cycleLength : DEFAULTS.cycleLength;\n\n  const startsAsc = (recordsAsc || []).map(r => r.start).filter(Boolean).sort();\n  if (startsAsc.length < 1) return null;\n\n  const todayStr = getTodayStr();\n  const currentStart = startsAsc[startsAsc.length - 1];\n  const currentLen = diffDays(currentStart, todayStr) + 1;\n\n  let lastStart = '', lastEnd = '', lastLen = 0, prevLen = 0;\n  if (startsAsc.length >= 2) {\n    lastStart = startsAsc[startsAsc.length - 2];\n    const nextStart = startsAsc[startsAsc.length - 1];\n    lastLen = diffDays(lastStart, nextStart);\n    const endD = parseDateStr(nextStart); endD.setDate(endD.getDate() - 1);\n    lastEnd = toDateStr(endD);\n  }\n  if (startsAsc.length >= 3) {\n    const prevStart = startsAsc[startsAsc.length - 3];\n    const prevNext = startsAsc[startsAsc.length - 2];\n    prevLen = diffDays(prevStart, prevNext);\n  }\n\n  const normalTag = (lastLen >= 21 && lastLen <= 35) ? '正常' : '偏离';\n  let deltaText = '—';\n  if (lastLen && prevLen) {\n    const delta = lastLen - prevLen;\n    deltaText = delta === 0 ? '持平' : (delta > 0 ? `多 ${delta} 天` : `少 ${Math.abs(delta)} 天`);\n  }\n\n  const items = [];\n  const currentDelta = currentLen - expected;\n  items.push({\n    dateLabel: formatMonthDayCN(currentStart),\n    status: currentDelta <= 0 ? '准时' : `推迟${currentDelta}天`,\n    lenText: `今天为当前周期${currentLen}天`,\n    len: currentLen,\n    isCurrent: true\n  });\n\n  let added = 0;\n  for (let i = startsAsc.length - 1; i >= 1 && added < 2; i--) {\n    const start = startsAsc[i - 1];\n    const next = startsAsc[i];\n    const len = diffDays(start, next);\n    if (len <= 0) continue;\n    const delta = len - expected;\n    let status = '准时';\n    if (delta > 0) status = `推迟${delta}天`;\n    else if (delta < 0) status = `提前${Math.abs(delta)}天`;\n    items.push({ dateLabel: formatMonthDayCN(start), status, lenText: `${len}天`, len, isCurrent: false });\n    added++;\n  }\n\n  /**\n   * 条形图标尺上限固定为「用户设定周期 + 22」\n   * 例如：设定 28 天 => 右侧上限 50 天\n   */\n  const fixedMaxLen = Math.max(1, expected + 22);\n\n  items.forEach((it) => {\n    const rawPct = (it.len / fixedMaxLen) * 100;\n    const pct = Math.round(rawPct);\n    it.barPct = clamp(pct, 18, 100);       // ✅ 最小可见宽度 + 最大不超出\n    it.barStyle = `width: ${it.barPct}%;`;\n  });\n\n  const rangeText = (lastStart && lastEnd) ? `最近 1 个周期（${lastStart} - ${lastEnd}）` : '最近 1 个周期（数据不足）';\n  return { rangeText, lastLenText: lastLen ? `${lastLen}天` : '—', normalTag, deltaText, items };\n}\n\nfunction analyzeStability(recordsAsc) {\n  const recent = getRecentRecords(recordsAsc, 4);\n  if (recent.length < 4) return { stdev: null, text: '数据不足（经期记录少于4次）' };\n  const lens = [];\n  for (let i = 1; i < recent.length; i++) lens.push(diffDays(recent[i - 1].start, recent[i].start));\n  const mean = lens.reduce((a, b) => a + b, 0) / lens.length;\n  const var0 = lens.reduce((a, b) => a + (b - mean) * (b - mean), 0) / lens.length;\n  const stdev = Math.sqrt(var0);\n  let text = '波动较大';\n  if (stdev <= 3) text = '较稳定';\n  else if (stdev <= 6) text = '略有波动';\n  return { stdev, text };\n}\nfunction getLatestPeriodWindow(recentRecord, settings) {\n  const start = recentRecord.start;\n  let end = recentRecord.end;\n  if (!end || end === start) {\n    const len = (settings && settings.periodLength) ? settings.periodLength : DEFAULTS.periodLength;\n    end = addDaysStr(start, Math.max(0, len - 1));\n  }\n  return { start, end };\n}\nfunction predictNext(recentStart, recentCycleLen, settings) {\n  const cycleLength = (settings && settings.cycleLength) ? settings.cycleLength : DEFAULTS.cycleLength;\n  const lutealDays = (settings && settings.lutealDays) ? settings.lutealDays : DEFAULTS.lutealDays;\n  const usedCycle = recentCycleLen > 0 ? recentCycleLen : cycleLength;\n  const nextStart = addDaysStr(recentStart, usedCycle);\n  const ovulationDay = addDaysStr(nextStart, -lutealDays);\n  const fertileStart = addDaysStr(ovulationDay, -5);\n  const fertileEnd = addDaysStr(ovulationDay, 1);\n  // return { nextStart, ovulationDay, fertileRangeText: formatRangeCN(fertileStart, fertileEnd) };\r\n  return { nextStart, ovulationDay, fertileStart, fertileEnd, fertileRangeText: formatRangeCN(fertileStart, fertileEnd) };\n}\r\n\r\n// 痛经记录\r\nfunction inRangeDateStr(ds, start, end) {\n  if (!ds || !start || !end) return false;\n  return ds >= start && ds <= end; // YYYY-MM-DD 字符串可直接比较\n}\n\nfunction buildPainTexts(painRecords, cycleStart, cycleEnd) {\n  const pr = painRecords && typeof painRecords === 'object' ? painRecords : {};\n  const levelOrder = ['轻微', '一般', '严重', '非常严重'];\n  const levelRank = {};\n  levelOrder.forEach((lv, i) => (levelRank[lv] = i));\n\n  const entries = [];\n  Object.keys(pr).forEach((ds) => {\n    if (!inRangeDateStr(ds, cycleStart, cycleEnd)) return;\n    const list = Array.isArray(pr[ds]) ? pr[ds] : [];\n    list.forEach((it) => entries.push({ ...it, _date: ds }));\n  });\n\n  const total = entries.length;\n  if (!total) {\n    return {\n      painSummaryText: '本周期未记录痛经',\n      painLevelText: '',\n      painPeakText: ''\n    };\n  }\n\n  // 统计程度\n  const counts = {};\n  let peakLv = '';\n  let peakRank = -1;\n\n  entries.forEach((it) => {\n    const lv = (it && it.level) ? it.level : '未选择程度';\n    counts[lv] = (counts[lv] || 0) + 1;\n\n    const r = (lv in levelRank) ? levelRank[lv] : -1;\n    if (r > peakRank) {\n      peakRank = r;\n      peakLv = lv;\n    }\n  });\n\n  // 最常见程度\n  let commonLv = '';\n  let commonCnt = 0;\n  Object.keys(counts).forEach((lv) => {\n    if (counts[lv] > commonCnt) {\n      commonCnt = counts[lv];\n      commonLv = lv;\n    }\n  });\n\n  // 分布文案（只展示有数据的项）\n  const distParts = levelOrder\n    .filter((lv) => counts[lv])\n    .map((lv) => `${lv}${counts[lv]}次`);\n  if (counts['未选择程度']) distParts.push(`未选择${counts['未选择程度']}次`);\n\n  return {\n    painSummaryText: `本周期记录痛经 ${total} 次（${cycleStart} ~ ${cycleEnd}）`,\n    painLevelText: distParts.length ? `程度分布：${distParts.join('，')}` : '',\n    painPeakText: peakLv ? `最严重程度：${peakLv}；最常见：${commonLv}` : ''\n  };\n}\n\r\n\n// 爱爱记录\r\nfunction buildSexTexts(store, rangeStart, rangeEnd, ovulationDay) {\n  const sexRecords = store.sexRecords || {};\n  const sexDates = Array.isArray(store.sexDates) ? store.sexDates : [];\n\n  function inRange(ds, a, b) { return ds && a && b && ds >= a && ds <= b; }\n  const unprotectedRe = /(无|不避孕|未避孕|不使用|没用)/;\n\n  let total = 0;\n  let withMethod = 0;\n  let unprotected = 0;\n\n  // 1) 详细记录\n  Object.keys(sexRecords).forEach((ds) => {\n    if (!inRange(ds, rangeStart, rangeEnd)) return;\n    const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n    total += list.length;\n\n    list.forEach((it) => {\n      const m = (it && it.method) ? String(it.method).trim() : '';\n      if (m) withMethod += 1;\n      if (!m || unprotectedRe.test(m)) unprotected += 1;\n    });\n  });\n\n  // 2) 兜底：只有小心心日期但没详细条目时，当天按 1 次\n  sexDates.forEach((ds) => {\n    if (!inRange(ds, rangeStart, rangeEnd)) return;\n    const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n    if (!list.length) total += 1;\n  });\n\n  // 3) 排卵期统计（-5 ~ +1）\n  let fertile = 0;\n  if (ovulationDay) {\n    const fs = addDaysStr(ovulationDay, -5);\n    const fe = addDaysStr(ovulationDay, 1);\n\n    Object.keys(sexRecords).forEach((ds) => {\n      if (!inRange(ds, fs, fe)) return;\n      const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n      fertile += list.length;\n    });\n\n    sexDates.forEach((ds) => {\n      if (!inRange(ds, fs, fe)) return;\n      const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n      if (!list.length) fertile += 1;\n    });\n  }\n\n  const missMethod = Math.max(0, total - withMethod);\n\n  return {\n    summary: `本周期记录爱爱 ${total} 次`,\n    fertile: ovulationDay ? `其中排卵期内 ${fertile} 次（按推算）` : '排卵期数据不足，无法统计',\n    unprotected: total === 0\n      ? '暂无避孕方式记录'\n      : (missMethod === 0 ? '避孕方式记录较完整' : `有 ${missMethod}/${total} 次未记录避孕方式（或标记为未避孕）`)\n  };\n}\n\r\n/**\n * 统计爱爱次数：按「月经期 / 排卵期 / 其他时间」归类；同时统计“未记录/未避孕”次数，用于风险估算。\n * 注意：为了和旧逻辑一致：\n * - sexRecords[ds] 里每条算 1 次\n * - sexDates 里若当天没有详细条目，则当天按 1 次（视为未记录避孕方式）\n */\nfunction buildSexPhaseCounts(store, rangeStart, rangeEnd, periodStart, periodEnd, fertileStart, fertileEnd) {\n  const sexRecords = store.sexRecords || {};\n  const sexDates = Array.isArray(store.sexDates) ? store.sexDates : [];\n  const unprotectedRe = /(无|不避孕|未避孕|不使用|没用)/;\n\n  function inRange(ds, a, b) { return ds && a && b && ds >= a && ds <= b; }\n  function bucketOf(ds) {\n    if (periodStart && periodEnd && inRange(ds, periodStart, periodEnd)) return 'period';\n    if (fertileStart && fertileEnd && inRange(ds, fertileStart, fertileEnd)) return 'ovulation';\n    return 'other';\n  }\n\n  const out = {\n    period: { total: 0, unprotected: 0 },\n    ovulation: { total: 0, unprotected: 0 },\n    other: { total: 0, unprotected: 0 }\n  };\n\n  // 1) 详细记录\n  Object.keys(sexRecords).forEach((ds) => {\n    if (!inRange(ds, rangeStart, rangeEnd)) return;\n    const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n    if (!list.length) return;\n\n    const key = bucketOf(ds);\n    out[key].total += list.length;\n\n    list.forEach((it) => {\n      const m = (it && it.method) ? String(it.method).trim() : '';\n      if (!m || unprotectedRe.test(m)) out[key].unprotected += 1;\n    });\n  });\n\n  // 2) 兜底：只有小心心日期但没详细条目时，当天按 1 次（并计为未记录避孕方式）\n  sexDates.forEach((ds) => {\n    if (!inRange(ds, rangeStart, rangeEnd)) return;\n    const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n    if (list.length) return;\n    const key = bucketOf(ds);\n    out[key].total += 1;\n    out[key].unprotected += 1;\n  });\n\n  return out;\n}\n\n// 简单风险估算：只做“提示”，不做医学承诺；系数后续可调\nfunction estimatePregnancyRatePct(curPhaseCounts) {\n  if (!curPhaseCounts) return 0;\n  const p = curPhaseCounts.period || { total: 0, unprotected: 0 };\n  const o = curPhaseCounts.ovulation || { total: 0, unprotected: 0 };\n  const other = curPhaseCounts.other || { total: 0, unprotected: 0 };\n\n  const totalAll = (p.total || 0) + (o.total || 0) + (other.total || 0);\n  if (!totalAll) return 0;\n\n  let risk = 0;\n  risk += (o.unprotected || 0) * 8;\n  risk += (o.total || 0) * 2;\n  risk += (other.unprotected || 0) * 1;\n\n  return clamp(risk, 0, 45);\n}\n\r\n\nexport default {\n  data() {\n    return {\n      hasData: false,\n      latestStart: '',\n      latestEnd: '',\n      latestPeriodLen: 0,\n      latestCycleLen: 0,\n      stabilityText: '',\n      confidenceText: '',\n      nextStart: '',\n      ovulationDay: '',\n      fertileRangeText: '',\n      cycleChange: null,\n      painSummaryText: '',\n      painLevelText: '',\n      painPeakText: '',\r\n\t  \r\n\t  // 本周期\"爱爱次数\"记录\n      sexSummaryText: '',\n      sexFertileText: '',\n      sexUnprotectedText: '',\r\n\t  // 上一周期\"爱爱次数\"记录\r\n\t  sexPrevSummaryText: '',\r\n\t  sexPrevFertileText: '',\r\n\t  sexPrevUnprotectedText: '',\r\n\t  // 新UI：顶部汇总 + 柱状图\r\n\t  sexCycleTotal: 0,\r\n\t  sexPregRateText: '0.0%',\r\n\t  // [{ label: '月经期', cur: 0, prev: 0, curPct: 0, prevPct: 0 }]\r\n\t  sexPhaseBars: [],\r\n\n\n      // 体重 7 天\n      weight7SubText: '近7天体重：暂无记录',\n      latest7WeightText: '--.--',\n      weightHintText: '体重记录不足（建议在经期前后多记录几天）',\n\n      // canvas 尺寸\n      canvasW: 1,\n      canvasH: 1,\n      canvasCssW: 0,\n      canvasCssH: 0,\n      dpr: 1\n    };\n  },\n  onLoad() { this.refresh(); },\n  onShow() { this.refresh(); },\n  methods: {\n    onGoWeight() {\n      uni.navigateTo({\n        // url: '/pages/subperiod/weight/weight',\n        fail: () => uni.showToast({ title: '“体重分析\"页维护中，请等等待下一次更新', icon: 'none' })\n      });\n    },\r\n\t\r\n\tonGoLove() {\r\n\t  uni.navigateTo({\r\n\t    url: '/pages/subperiod/love/love',\r\n\t    // fail: () => uni.showToast({ title: '“爱爱\"页维护中', icon: 'none' })\r\n\t  });\r\n\t},\n\n    refresh() {\n      const store = normalizeStore(loadStore());\n      const settings = store.settings || DEFAULTS;\n      const recordsAsc = store.periodRecords || [];\n\n      // 体重：无论是否记录经期，都绘制\n      const w7 = this.buildWeight7Series(store.weightRecords);\n      this.setData({\n        weight7SubText: w7.subText,\n        latest7WeightText: w7.latestText,\n        weightHintText: w7.hintText\n      });\n      this.$nextTick(() => this.measureCanvasAndDraw(w7));\n\n      // 无经期记录：上面周期/痛经/行为不展示\n      if (!recordsAsc.length) {\n        this.setData({\n          hasData: false,\n          latestStart: '',\n          latestEnd: '',\n          latestPeriodLen: 0,\n          latestCycleLen: 0,\n          stabilityText: '',\n          confidenceText: '',\n          nextStart: '',\n          ovulationDay: '',\n          fertileRangeText: '',\n          cycleChange: null,\n          painSummaryText: '',\n          painLevelText: '',\n          painPeakText: '',\n          sexSummaryText: '',\n          sexFertileText: '',\n          sexUnprotectedText: '',\r\n\t\t  sexPrevSummaryText: '',\r\n\t\t  sexPrevFertileText: '',\r\n\t\t  sexPrevUnprotectedText: '',\r\n\t\t  \r\n\t\t  sexCycleTotal: 0,\r\n\t\t  sexPregRateText: '0.0%',\r\n\t\t  sexPhaseBars: [],\r\n\r\n\n        });\n        return;\n      }\n\n      const recent = getRecentRecords(recordsAsc, 1)[0];\n      const w0 = getLatestPeriodWindow(recent, settings);\n      const latestStart = w0.start;\n      const latestEnd = w0.end;\n      const latestPeriodLen = diffDays(latestStart, addDaysStr(latestEnd, 1));\n\n      const recent2 = getRecentRecords(recordsAsc, 2);\n      let latestCycleLen = 0;\n      if (recent2.length >= 2) latestCycleLen = diffDays(recent2[0].start, recent2[1].start);\n\n      const stab = analyzeStability(recordsAsc);\n      const stabilityText = stab.text;\n      const confidenceText = recordsAsc.length >= 6 ? '高（记录较多）' : recordsAsc.length >= 4 ? '中（记录一般）' : '低（记录偏少）';\n\n      const pred = predictNext(latestStart, latestCycleLen, settings);\r\n\t  const todayStr = getTodayStr();\r\n\t  \r\n\t  // 本周期范围：latestStart ~ (下次预计开始前一天)，没有预测就到今天\r\n\t  const thisCycleEnd = pred.nextStart ? addDaysStr(pred.nextStart, -1) : todayStr;\r\n\t  const thisSex = buildSexTexts(store, latestStart, thisCycleEnd, pred.ovulationDay);\r\n\t  \r\n\t  // 上一周期：start = 前一次经期开始；end = 本次开始前一天\r\n\t  let prevSex = { summary: '上一周期数据不足', fertile: '', unprotected: '' };\r\n\t  \r\n\t  // === 新UI：按阶段统计（本周期 vs 上周期） ===\r\n\t  // 本周期：月经期范围（latestStart ~ latestEnd），排卵期范围（pred.fertileStart ~ pred.fertileEnd）\r\n\t  const curPhaseCounts = buildSexPhaseCounts(\r\n\t    store,\r\n\t    latestStart,\r\n\t    thisCycleEnd,\r\n\t    latestStart,\r\n\t    latestEnd,\r\n\t    pred.fertileStart,\r\n\t    pred.fertileEnd\r\n\t  );\r\n\t  \r\n\t  // 上一周期：需要上一条经期记录的「经期窗口」\r\n\t  let prevPhaseCounts = {\r\n\t    period: { total: 0, unprotected: 0 },\r\n\t    ovulation: { total: 0, unprotected: 0 },\r\n\t    other: { total: 0, unprotected: 0 }\r\n\t  };\r\n\t  const startsAsc = (recordsAsc || []).map(r => r.start).filter(Boolean).sort();\r\n\t  if (startsAsc.length >= 2) {\r\n\t    const prevRecord = recordsAsc[recordsAsc.length - 2];\r\n\t    const prevWindow = getLatestPeriodWindow(prevRecord, settings);\r\n\t    const prevStart = prevWindow.start;\r\n\t    const prevPeriodEnd = prevWindow.end;\r\n\t    const prevEnd = addDaysStr(latestStart, -1);\r\n\t    const prevCycleLen = diffDays(prevStart, latestStart);\r\n\t    const prevPred = predictNext(prevStart, prevCycleLen, settings);\r\n\t  \r\n\t    prevPhaseCounts = buildSexPhaseCounts(\r\n\t      store,\r\n\t      prevStart,\r\n\t      prevEnd,\r\n\t      prevStart,\r\n\t      prevPeriodEnd,\r\n\t      prevPred.fertileStart,\r\n\t      prevPred.fertileEnd\r\n\t    );\r\n\t  }\r\n\t  \r\n\t  // 柱状图数据 + 百分比高度\r\n\t  const chart = [\r\n\t    { label: '月经期', cur: curPhaseCounts.period.total, prev: prevPhaseCounts.period.total },\r\n\t    { label: '排卵期', cur: curPhaseCounts.ovulation.total, prev: prevPhaseCounts.ovulation.total },\r\n\t    { label: '其他时间', cur: curPhaseCounts.other.total, prev: prevPhaseCounts.other.total }\r\n\t  ];\r\n\t  const maxVal = Math.max(0, ...chart.map(x => x.cur), ...chart.map(x => x.prev));\r\n\t  const denom = maxVal > 0 ? maxVal : 1;\r\n\t  \r\n\t  const withPct = chart.map((it) => {\r\n\t    const curPct0 = Math.round((it.cur / denom) * 100);\r\n\t    const prevPct0 = Math.round((it.prev / denom) * 100);\r\n\t    // 视觉：非 0 最低给一点高度，避免“1次”看不见\r\n\t    const curPct = it.cur > 0 ? Math.max(10, curPct0) : 0;\r\n\t    const prevPct = it.prev > 0 ? Math.max(10, prevPct0) : 0;\r\n\t    return { ...it, curPct, prevPct };\r\n\t  });\r\n\t  \r\n\t  const sexCycleTotal = chart.reduce((s, x) => s + (x.cur || 0), 0);\r\n\t  const riskPct = estimatePregnancyRatePct(curPhaseCounts);\r\n\t  const sexPregRateText = `${riskPct.toFixed(1)}%`;\r\n\r\n\t  \r\n\t //  const startsAsc = (recordsAsc || []).map(r => r.start).filter(Boolean).sort();\r\n\t //  if (startsAsc.length >= 2) {\r\n\t //    const prevStart = startsAsc[startsAsc.length - 2];\r\n\t //    const prevEnd = addDaysStr(latestStart, -1);\r\n\t //    const prevCycleLen = diffDays(prevStart, latestStart);\r\n\t //    const prevPred = predictNext(prevStart, prevCycleLen, settings);\r\n\t //    prevSex = buildSexTexts(store, prevStart, prevEnd, prevPred.ovulationDay);\r\n\t  \r\n\t //    // 给上一周期文案加前缀，避免和本周期混淆\r\n\t //    // prevSex.summary = `上一周期：${prevSex.summary.replace('本周期', '')}`.replace('记录爱爱', '记录爱爱');\r\n\t //    // prevSex.fertile = prevSex.fertile ? `上一周期：${prevSex.fertile}` : '';\r\n\t //    // prevSex.unprotected = prevSex.unprotected ? `上一周期：${prevSex.unprotected}` : '';\r\n\t\t// prevSex.summary = `上一周期：${prevSex.summary}`;\r\n\t\t// prevSex.fertile = prevSex.fertile ? `上一周期：${prevSex.fertile}` : '';\r\n\t\t// prevSex.unprotected = prevSex.unprotected ? `上一周期：${prevSex.unprotected}` : '';\r\n\r\n\t //  }\r\n\n\n      // const cycleChange = buildCycleChangeCard(recordsAsc, settings);\n\n      // const painSummaryText = this.painSummaryText || '最近3个周期未记录痛经';\n      // const painLevelText = this.painLevelText || '';\n      // const painPeakText = this.painPeakText || '';\r\n\t  const cycleChange = buildCycleChangeCard(recordsAsc, settings);\r\n\t  \r\n\t  // ✅ 痛经：从 store.painRecords 现算（本周期范围：latestStart ~ thisCycleEnd）\r\n\t  const painTexts = buildPainTexts(store.painRecords, latestStart, thisCycleEnd);\r\n\t  const painSummaryText = painTexts.painSummaryText;\r\n\t  const painLevelText = painTexts.painLevelText;\r\n\t  const painPeakText = painTexts.painPeakText;\r\n\n      this.setData({\n        hasData: true,\n        latestStart,\n        latestEnd,\n        latestPeriodLen,\n        latestCycleLen,\n        stabilityText,\n        confidenceText,\n        nextStart: pred.nextStart,\n        ovulationDay: pred.ovulationDay,\n        fertileRangeText: pred.fertileRangeText,\n        cycleChange,\n        painSummaryText,\n        painLevelText,\n        painPeakText,\n        // sexSummaryText,\n        // sexFertileText,\n        // sexUnprotectedText\r\n\t\tsexSummaryText: thisSex.summary,\n\t\tsexFertileText: thisSex.fertile,\n\t\tsexUnprotectedText: thisSex.unprotected,\n\n\t\tsexPrevSummaryText: prevSex.summary,\n\t\tsexPrevFertileText: prevSex.fertile,\n\t\tsexPrevUnprotectedText: prevSex.unprotected,\n\r\n\t\tsexCycleTotal,\r\n\t\tsexPregRateText,\r\n\t\tsexPhaseBars: withPct,\r\n\n      });\n    },\n\n    // 今天往前 7 天（含今天）；哪怕只记录 1 天也展示\n    buildWeight7Series(weightRecords) {\n      const today = new Date();\n      const days = [];\n      const labels = [];\n      for (let i = 6; i >= 0; i--) {\n        const d = new Date(today);\n        d.setDate(d.getDate() - i);\n        const ds = toDateStr(d);\n        days.push(ds);\n        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);\n      }\n\n      const map = {};\n      (weightRecords || []).forEach((r) => {\n        if (!r || !r.date) return;\n        if (typeof r.weight !== 'number' || Number.isNaN(r.weight)) return;\n        map[r.date] = r.weight;\n      });\n\n      const values = days.map(ds => (map[ds] != null ? map[ds] : null));\n      const exist = values.filter(v => typeof v === 'number');\n\n      let latestVal = null;\n      const todayStr = days[6];\n      if (map[todayStr] != null) latestVal = map[todayStr];\n      else {\n        for (let i = 6; i >= 0; i--) {\n          const ds = days[i];\n          if (map[ds] != null) { latestVal = map[ds]; break; }\n        }\n      }\n\n      let subText = '近7天体重：暂无记录';\n      let latestText = '--.--';\n      let hintText = '体重记录不足（建议在经期前后多记录几天）';\n\n      if (exist.length) {\n        const min = Math.min(...exist);\n        const max = Math.max(...exist);\n        const wave = max - min;\n        subText = `已记录 ${exist.length}/7 天 · 最近 ${fmt2(latestVal)}kg · 周期内最大波动 ${fmt2(wave)}kg`;\n        latestText = fmt2(latestVal);\n        hintText = exist.length >= 3 ? '' : '体重记录不足（建议在经期前后多记录几天）';\n      }\n\n      return { labels, values, subText, latestText, hintText };\n    },\n\n    // 测量尺寸 + 绘制\n    measureCanvasAndDraw(series) {\n      uni.createSelectorQuery()\n        .in(this)\n        .select('#weight7Canvas')\n        .boundingClientRect((rect) => {\n          if (!rect || !rect.width || !rect.height) return;\n\n          const W = Math.max(1, Math.round(rect.width));\n          const H = Math.max(1, Math.round(rect.height));\n\n          this.setData(\n            { canvasW: W, canvasH: H, canvasCssW: rect.width, canvasCssH: rect.height, dpr: 1 },\n            () => this.drawWeight7Canvas(series)\n          );\n        })\n        .exec();\n    },\n\n    drawWeight7Canvas(series) {\r\n\t  const ctx = uni.createCanvasContext('weight7Canvas', this);\r\n\t\r\n\t  const W = this.canvasW || 300;\r\n\t  const H = this.canvasH || 160;\r\n\t\r\n\t  ctx.clearRect(0, 0, W, H);\r\n\t\r\n\t  // padding（像素）\r\n\t  const padL = 18;\r\n\t  const padR = 18;\r\n\t  const padT = 10;\r\n\t  const padB = 34; // ✅ 底部稍微再留一点：要放7个日期\r\n\t\r\n\t  const innerW = W - padL - padR;\r\n\t  const innerH = H - padT - padB;\r\n\t\r\n\t  // 网格线\r\n\t  ctx.setStrokeStyle('#f2f2f2');\r\n\t  ctx.setLineWidth(1);\r\n\t  for (let i = 0; i <= 3; i++) {\r\n\t    const y = padT + Math.round((innerH * i) / 3);\r\n\t    ctx.beginPath();\r\n\t    ctx.moveTo(padL, y);\r\n\t    ctx.lineTo(W - padR, y);\r\n\t    ctx.stroke();\r\n\t  }\r\n\t\r\n\t  // x 坐标（固定 7 天）\r\n\t  const xs = [];\r\n\t  for (let i = 0; i < 7; i++) xs.push(padL + Math.round((innerW * i) / 6));\r\n\t\r\n\t  const values = series.values || [];\r\n\t  const labels = series.labels || []; // \"M/D\"\r\n\t\r\n\t  // ✅ 横坐标：每天都显示（7个都显示）\r\n\t  ctx.setFillStyle('#999');\r\n\t  ctx.setFontSize(9); // ✅ 字更小一点，避免拥挤\r\n\t  for (let i = 0; i < labels.length; i++) {\r\n\t    const lb = labels[i] || '';\r\n\t    const x = xs[i];\r\n\t\r\n\t    const estW = lb.length * 5.2;\r\n\t    let tx = x - estW / 2;\r\n\t\r\n\t    // 边界保护：不出画布\r\n\t    tx = Math.max(2, Math.min(W - estW - 2, tx));\r\n\t\r\n\t    // 底部位置\r\n\t    ctx.fillText(lb, tx, H - 8);\r\n\t  }\r\n\t\r\n\t  const nums = values.filter(v => typeof v === 'number');\r\n\t  if (!nums.length) {\r\n\t    ctx.draw();\r\n\t    return;\r\n\t  }\r\n\t\r\n\t  let minV = Math.min(...nums);\r\n\t  let maxV = Math.max(...nums);\r\n\t  if (maxV - minV < 0.6) maxV = minV + 0.6;\r\n\t\r\n\t  const yOf = (v) => {\r\n\t    const t = (v - minV) / (maxV - minV);\r\n\t    const y = padT + innerH * (1 - t);\r\n\t    return Math.max(padT, Math.min(padT + innerH, y));\r\n\t  };\r\n\t\r\n\t  // 折线（遇到 null 断开）\r\n\t  ctx.setStrokeStyle('#ff6b9a');\r\n\t  ctx.setLineWidth(3);\r\n\t  let started = false;\r\n\t\r\n\t  values.forEach((v, i) => {\r\n\t    if (typeof v !== 'number') {\r\n\t      if (started) ctx.stroke();\r\n\t      started = false;\r\n\t      return;\r\n\t    }\r\n\t    const x = xs[i];\r\n\t    const y = yOf(v);\r\n\t    if (!started) {\r\n\t      ctx.beginPath();\r\n\t      ctx.moveTo(x, y);\r\n\t      started = true;\r\n\t    } else {\r\n\t      ctx.lineTo(x, y);\r\n\t    }\r\n\t  });\r\n\t  if (started) ctx.stroke();\r\n\t\r\n\t  // ✅ 点（粉色不变）\r\n\t  const r = 4;\r\n\t  ctx.setFillStyle('#ff6b9a');\r\n\t\r\n\t  // ✅ 文字：统一深灰色 & 放在点下面\r\n\t  const textColor = '#444';\r\n\t  const fontSize = 10; // 不能太大\r\n\t  ctx.setFontSize(fontSize);\r\n\t  ctx.setFillStyle(textColor);\r\n\t\r\n\t  values.forEach((v, i) => {\r\n\t    if (typeof v !== 'number') return;\r\n\t\r\n\t    const x = xs[i];\r\n\t    const y = yOf(v);\r\n\t\r\n\t    // 点要用粉色画（注意：我们刚刚把 fillStyle 改深灰了，所以这里先切回粉色）\r\n\t    ctx.setFillStyle('#ff6b9a');\r\n\t    ctx.beginPath();\r\n\t    ctx.arc(x, y, r, 0, Math.PI * 2);\r\n\t    ctx.fill();\r\n\t\r\n\t    // 再切回深灰写字\r\n\t    ctx.setFillStyle(textColor);\r\n\t\r\n\t    const text = `${v.toFixed(2)}kg`;\r\n\t    const estW = text.length * 5.5;\r\n\t    let tx = x - estW / 2;\r\n\t\r\n\t    // 边界保护\r\n\t    tx = Math.max(2, Math.min(W - estW - 2, tx));\r\n\t\r\n\t    // ✅ 放点下面：y + 16\r\n\t    // 同时防止贴到最底部（要给日期让位）\r\n\t    const maxTextY = H - 18;        // 离底部留点空间给日期\r\n\t    const ty = Math.min(maxTextY, y + 16);\r\n\t\r\n\t    ctx.fillText(text, tx, ty);\r\n\t  });\r\n\t\r\n\t  ctx.draw();\r\n\t},\r\n\n  }\n};\n</script>\n\n<style>\n@import './analysis.css';\n</style>\n","import mod from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./analysis.vue?vue&type=style&index=0&lang=css&\"; export default mod; export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./analysis.vue?vue&type=style&index=0&lang=css&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1768876148806\n      var cssReload = require(\"D:/Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"/\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}