{"version":3,"sources":["uni-app:///main.js","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?6911","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?af85","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?153a","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?e92d","uni-app:///pages/subperiod/love/love.vue","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?dafc","webpack:///D:/PrivateFiles/HBuilderProjects/ID-Local/pages/subperiod/love/love.vue?2009"],"names":["wx","__webpack_require_UNI_MP_PLUGIN__","__webpack_require__","createPage","Page","cycleLength","periodLength","lutealDays","y","m","d","store","data","cycleText","prevCycleText","riskTips","riskHint","trendSubText","methodSubText","metrics","totalThis","daysWith","avgText","maxGapText","trendDates","trendLabels","trendValues","methodLegend","recentList","barTip","show","left","top","date","value","canvasW","barH","pieH","onLoad","onShow","methods","goAdd","uni","url","refresh","cycleLen","entriesThis","unprotectedThis","fertileTimes","hasFertile","fertileRangeText","slice","sort","map","dateLabel","time","method","cycleStart","fertileStart","inRange","collectSexEntries","Object","total","daysSet","list","entries","buildMetrics","buildRiskTips","tips","hint","buildTrend30","dates","labels","values","subText","buildMethodPie","k","v","arr","label","color","slices","legend","measureAndDrawBar","in","select","boundingClientRect","width","height","exec","drawBar","ctx","pL","pT","w","h","bw","gap","n","getCanvasPoint","x","onBarTouch","drawPieImpl","start","drawPie"],"mappings":";;;;;;;;;;;;;AAAA;AAGA;AACA;AAHA;AACAA,EAAE,CAACC,iCAAiC,GAAGC,mBAAmB;AAG1DC,UAAU,CAACC,aAAI,CAAC,C;;;;;;;;;;;;;ACLhB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAiH;AACjH;AACwD;AACL;AACa;AACA;;;AAGhE;AACqL;AACrL,gBAAgB,yLAAU;AAC1B,EAAE,0EAAM;AACR,EAAE,+EAAM;AACR,EAAE,wFAAe;AACjB;AACA;AACA;AACA;AACA;AACA,EAAE,mFAAU;AACZ;AACA;;AAEA;AACe,gF;;;;;;;;;;;;ACxBf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,MAAM;AACN;AACA;AACA;AACA,OAAO;AACP;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;ACjBA;AAAA;AAAA;AAAA;AAA2rB,CAAgB,0qBAAG,EAAC,C;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACkJ/sB;AACA;EAAAC;EAAAC;EAAAC;AAAA;AAEA;EAAA;AAAA;AACA;EAAA;AAAA;AACA;EAAA;EAAA;IAAA;IAAAC;IAAAC;IAAAC;EAAA;AAAA;AACA;EACA;EACA;EACAA;EACA;AACA;AACA;EACA;EAAA;EACA;EACA;AACA;AACA;EAAA;AAAA;AAEA;EACA;AACA;AACA;EACAC;EACAA;EACAA;EACAA;IAAA;EAAA;EACA;AACA;;AAEA;AACA;EACA;EACA;EACA;EACA;EACA;AACA;AAAA,eAEA;EACAC;IACA;MACAC;MACAC;MACAC;MACAC;MACAC;MACAC;MAEAC;QACAC;QACAC;QACAC;QACAC;MACA;MAEAC;MACAC;MACAC;MAEAC;MACAC;MAEA;MACAC;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;MAAA;MAEA;MACAC;MACAC;MACAC;IACA;EACA;EAEAC;IACA;EACA;EACAC;IACA;EACA;EAEAC;IACAC;MACA;MACA;MACA;MACAC;QAAAC;MAAA;IACA;IAEAC;MAAA;MACA;MACA;;MAEA;MACA;MACA;MACA;;MAEA;MACA;MACA;QACA;QACAC;MACA;MACA;MAEA;MAEA;MACA;MACA;;MAEA;MACA,4BACA;QADAC;QAAA1B;QAAAC;QAAA0B;QAAAC;MAGA;MACA7B;MACAA;MAEA;QACAC;QACA2B;QACAC;QACAC;QACAC;MACA;MAEA;MACA;MAEA,6BACAC,QACAC;QAAA;MAAA,GACAD,YACAE;QAAA;UACAC;UACAC;UACAC;QACA;MAAA;MAEA,2EACAC,6HACA;MAEA,6FACAC,0CACA;MAEA;QACAvC;QACAN;QACAC;QACAC;QACAC;QACAC;QACAC;QACAM;QACAC;QACAC;QACAC;QACAC;QACAC;UAAAC;UAAAC;UAAAC;UAAAC;UAAAC;QAAA;MACA;MAEA;QACA;QACA;MACA;IACA;IAEAyB;MACA;IACA;IAEA;IACAC;MAAA;MACA;MAEA;MACA;MACA;MACA;MACA;MAEAC;QACA;QACA;QACA;QAEAC;QACAC;QAEAC;UACA;UACA;UACAC;YAAAhC;YAAAsB;YAAAC;UAAA;UAEA;UACA;QACA;MACA;MAEA;QACAV;QACA1B;QACAC;QACA0B;QACAC;MACA;IACA;IAEAkB;MACA;;MAEA;MACA;MACA;QACA;QACA5C;MACA;QACAA;MACA;;MAEA;MACA;MACA;QAAA;MAAA;MACA;MACA;QACA;QACA;UACA;UACA;QACA;QACAC;MACA;QACAA;MACA;MAEA;QAAAH;QAAAC;QAAAC;QAAAC;MAAA;IACA;IAEA4C;MAAA;QAAApB;QAAAC;QAAAC;QAAAC;MACA;MAEA;QACAkB;QACA;UACAA;UACAC;QACA;MACA;MAEA;QACAD;MACA;QACAA;MACA;MAEA;QACAA;QACA;UACAA;QACA;MACA;QACAA;MACA;MAEA;QACAA;MACA;MAEA;QACAA;QACAC;MACA;IACA;IAEA;IACAC;MACA;MACA;MACA;MAEA;QACA;QACA5D;QACA;QACA6D;QACAC;MACA;MAEA;QACA;QACA;MACA;MAEA;QAAA;MAAA;MACA;MAEA,iEACAV,0EACA;MAEA;QAAAS;QAAAC;QAAAC;QAAAC;MAAA;IACA;IAEA;IACAC;MACA;MACA;QACA;QACA;QACA;MACA;MAEA7B;QACA;QACAO;MACA;MAEA;QAAA;UAAAuB;UAAAC;QAAA;MAAA;MACAC;QAAA;MAAA;MAEA;MACA;MACA;QAAA;MAAA;MACA;QAAAF;QAAAC;MAAA;MAEA;MAEA;QAAA;UACAE;UACA7C;UACA8C;QACA;MAAA;MAEA;QAAA;UACAD;UACA7C;UACA8C;QACA;MAAA;MAEA;MACA;QAAA9D;MAAA;MAEA;QAAA+D;QAAAC;QAAAR;MAAA;IACA;IAEA;IACAS;MAAA;MACAzC,0BACA0C,SACAC,qBACAC;QACA;;QAEA;QACA;UACAvD;UACAC;UACAuD;UACAC;QACA;QAEA;QACA;QAEA;UAAArD;UAAAC;QAAA;QAEA;UACA;QACA;MACA,GACAqD;IACA;IAEAC;MACA;;MAEA;MACA;MACA;MACA;MACA;MAEA;MACA;MAEAC;MACAA;MACAA;MAEA;;MAEA;MACAA;MACAA;MACA;QACA;QACAA;QACAA;QACAA;QACAA;MACA;;MAEA;MACAA;MACAA;MACAA;;MAEA;MACA;MACA;MACA;MAEA;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;MAAA;MACA;MACA;MACA;MAEA;QACA;QACA;QACA;QACA;QAEAP;QACAA;;QAEA;QACA;UACAA;UACAA;UACAA;QACA;MACA;MAEAA;IACA;IAEA;IACAQ;MACA;MACA;MAEA;MACA;;MAEA;MACA;QACA;UAAAC;UAAA5F;QAAA;MACA;MAEA;MACA;MACA;MAEA;QAAA4F;QAAA5F;MAAA;IACA;IAEA6F;MACA;MACA;MAEA;MACA;MAEA;QAAAT;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;QAAAC;;MAEA;MACA;QACA;UAAArE;YAAAC;YAAAC;YAAAC;YAAAC;YAAAC;UAAA;QAAA;QACA;MACA;;MAEA;MACA;MACA;MAEA;MACA;;MAEA;MACA;MACA;MACA;MAEA;MACA;MACA;MAEA;MACA;MAEA;QACAL;UACAC;UACAC;UACAC;UACAC;UACAC;QACA;MACA;IACA;IAEA;IACAoE;MACA;MACAX;MAEAA;MACAA;MAEA;MACA;MACA;MACA;MAEA;QAAA;MAAA;MACA;MAEAV;QACA;QACA;QAEAU;QACAA;QACAA;QACAA;QACAA;QACAA;QAEAY;MACA;;MAEA;MACAZ;MACAA;MACAA;MACAA;;MAEA;MACAA;MACAA;MACAA;MACAA;MACAA;MAEAA;IACA;IAEAa;MAAA;MACA9D,0BACA0C,SACAC,qBACAC;QACA;QAEA;QACA;QAEA;UAAAnD;UAAAE;QAAA;QAEA;UACA;QACA;MACA,GACAoD;IACA;EACA;AACA;AAAA,2B;;;;;;;;;;;;;AC5sBA;AAAA;AAAA;AAAA;AAAk/B,CAAgB,u7BAAG,EAAC,C;;;;;;;;;;;ACAtgC;AACA,OAAO,KAAU,EAAE,kBAKd","file":"pages/subperiod/love/love.js","sourcesContent":["import 'uni-pages';\n// @ts-ignore\nwx.__webpack_require_UNI_MP_PLUGIN__ = __webpack_require__;\nimport Vue from 'vue'\nimport Page from './pages/subperiod/love/love.vue'\ncreatePage(Page)","import { render, staticRenderFns, recyclableRender, components } from \"./love.vue?vue&type=template&id=75159bf8&\"\nvar renderjs\nimport script from \"./love.vue?vue&type=script&lang=js&\"\nexport * from \"./love.vue?vue&type=script&lang=js&\"\nimport style0 from \"./love.css?vue&type=style&index=0&lang=css&\"\nimport style1 from \"./love.vue?vue&type=style&index=1&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"pages/subperiod/love/love.vue\"\nexport default component.exports","export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--17-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./love.vue?vue&type=template&id=75159bf8&\"","var components\nvar render = function () {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n  var g0 = _vm.recentList.length\n  _vm.$mp.data = Object.assign(\n    {},\n    {\n      $root: {\n        g0: g0,\n      },\n    }\n  )\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./love.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--13-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./love.vue?vue&type=script&lang=js&\"","<template>\n  <view class=\"page\">\n\n    <!-- 顶部标题 -->\n    <!-- <view class=\"card header-card\">\n      <view class=\"header\">\n        <text class=\"title\">行为与风险提示</text>\n        <text class=\"sub\">基于你已记录的爱爱数据生成（仅供参考）</text>\n      </view>\n    </view> -->\n\n    <!-- 概览 -->\n    <view class=\"card\">\n      <view class=\"card-title\">\n        <image class=\"card-title-icon\" src=\"/static/assets/icons/f_sax.svg\" mode=\"aspectFit\" />\n        <text class=\"card-title-text\">本周期概览</text>\n      </view>\n\n      <view class=\"grid\">\n        <view class=\"grid-item\">\n          <text class=\"gi-k\">本周期次数</text>\n          <text class=\"gi-v\">{{ metrics.totalThis }}</text>\n        </view>\n        <view class=\"grid-item\">\n          <text class=\"gi-k\">有记录的天数</text>\n          <text class=\"gi-v\">{{ metrics.daysWith }}</text>\n        </view>\n        <view class=\"grid-item\">\n          <text class=\"gi-k\">平均频率</text>\n          <text class=\"gi-v\">{{ metrics.avgText }}</text>\n        </view>\n        <view class=\"grid-item\">\n          <text class=\"gi-k\">本周期最长间隔</text>\n          <text class=\"gi-v\">{{ metrics.maxGapText }}</text>\n        </view>\n      </view>\n\n      <view class=\"p\" v-if=\"cycleText\">{{ cycleText }}</view>\n      <view class=\"p\" v-if=\"prevCycleText\">{{ prevCycleText }}</view>\n    </view>\n\n    <!-- 风险提示 -->\n    <view class=\"card\">\n      <view class=\"card-title card-title--with-right\">\n        <view class=\"card-title-left\">\n          <image class=\"card-title-icon\" src=\"/static/assets/icons/f_fxts.svg\" mode=\"aspectFit\" />\n          <text class=\"card-title-text\">风险提示</text>\n        </view>\n      </view>\n\n      <view class=\"risk-list\">\n        <view class=\"risk-item\" v-for=\"(it, idx) in riskTips\" :key=\"idx\">\n          <view class=\"dot\"></view>\n          <text class=\"risk-text\">{{ it }}</text>\n        </view>\n      </view>\n\n      <view class=\"hint\" v-if=\"riskHint\">{{ riskHint }}</view>\n    </view>\n\n    <!-- 近30天趋势（柱状图） -->\n    <view class=\"card\">\n      <view class=\"card-title\">\n        <image class=\"card-title-icon\" src=\"/static/assets/icons/f_rq.svg\" mode=\"aspectFit\" />\n        <text class=\"card-title-text\">近30天次数趋势</text>\n      </view>\n\n      <view class=\"chart-sub\">{{ trendSubText }}</view>\n\n      <view class=\"chart-wrap\">\n        <canvas\n          class=\"canvas\"\n          id=\"barCanvas\"\n          canvas-id=\"barCanvas\"\n          :width=\"canvasW\"\n          :height=\"barH\"\n          @touchstart=\"onBarTouch\"\n        ></canvas>\n\n        <!-- 点击某个柱子后出现的小方框 -->\n        <view\n          v-if=\"barTip.show\"\n          class=\"bar-tip\"\n          :style=\"{ left: barTip.left + 'px', top: barTip.top + 'px' }\"\n        >\n          <text class=\"bar-tip-date\">{{ barTip.date }}</text>\n          <text class=\"bar-tip-val\">{{ barTip.value }} 次</text>\n        </view>\n      </view>\n\n      <view class=\"p small\">提示：只显示每日次数。点击某个柱子可查看该日日期与次数。</view>\n    </view>\n\n    <!-- 措施分布（饼图） -->\n    <view class=\"card\">\n      <view class=\"card-title\">\n        <image class=\"card-title-icon\" src=\"/static/assets/icons/f_dp.svg\" mode=\"aspectFit\" />\n        <text class=\"card-title-text\">措施分布（本周期）</text>\n      </view>\n\n      <view class=\"chart-sub\">{{ methodSubText }}</view>\n\n      <canvas\n        class=\"canvas\"\n        id=\"pieCanvas\"\n        canvas-id=\"pieCanvas\"\n        :width=\"canvasW\"\n        :height=\"pieH\"\n      ></canvas>\n\n      <view class=\"legend\">\n        <view class=\"legend-item\" v-for=\"(l, idx) in methodLegend\" :key=\"idx\">\n          <view class=\"legend-color\" :style=\"{ backgroundColor: l.color }\"></view>\n          <text class=\"legend-text\">{{ l.label }}</text>\n          <text class=\"legend-val\">{{ l.value }}</text>\n        </view>\n      </view>\n    </view>\n\n    <!-- 最近记录 -->\n    <view class=\"card\">\n      <view class=\"card-title\">\n        <image class=\"card-title-icon\" src=\"/static/assets/icons/f_sj.svg\" mode=\"aspectFit\" />\n        <text class=\"card-title-text\">最近记录（5条）</text>\n      </view>\n\n      <view v-if=\"recentList.length\" class=\"recent\">\n        <view class=\"recent-item\" v-for=\"(r, idx) in recentList\" :key=\"idx\">\n          <view class=\"recent-left\">\n            <text class=\"recent-date\">{{ r.dateLabel }}</text>\n            <text class=\"recent-time\">{{ r.time }}</text>\n          </view>\n          <text class=\"recent-method\">{{ r.method }}</text>\n        </view>\n      </view>\n\n      <view v-else class=\"empty\">\n        <text class=\"empty-text\">还没有爱爱记录哦～先去记录一条吧</text>\n        <view class=\"btn\" @tap=\"goAdd\">去记录</view>\n      </view>\n    </view>\n\n  </view>\n</template>\n\n<script>\nconst STORE_KEY = 'period_record_v1';\nconst DEFAULTS = { cycleLength: 28, periodLength: 5, lutealDays: 14 };\n\nfunction pad2(n) { return (n < 10 ? '0' : '') + n; }\nfunction toDateStr(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }\nfunction parseDateStr(s) { if (!s) return null; const [y, m, d] = s.split('-').map(Number); return new Date(y, m - 1, d); }\nfunction addDaysStr(dateStr, days) {\n  const d = parseDateStr(dateStr);\n  if (!d) return '';\n  d.setDate(d.getDate() + days);\n  return toDateStr(d);\n}\nfunction diffDays(aStr, bStr) {\n  const a = parseDateStr(aStr); const b = parseDateStr(bStr);\n  if (!a || !b) return 0;\n  return Math.round((b - a) / 86400000);\n}\nfunction getTodayStr() { return toDateStr(new Date()); }\n\nfunction loadStore() {\n  return uni.getStorageSync(STORE_KEY) || {};\n}\nfunction normalizeStore(store) {\n  store.settings = store.settings || { ...DEFAULTS };\n  store.periodRecords = Array.isArray(store.periodRecords) ? store.periodRecords : [];\n  store.sexRecords = (store.sexRecords && typeof store.sexRecords === 'object' && !Array.isArray(store.sexRecords)) ? store.sexRecords : {};\n  store.periodRecords.sort((a, b) => (a.start || '').localeCompare(b.start || ''));\n  return store;\n}\n\n// 预测排卵日：cycleStart + (cycleLen - lutealDays)\nfunction estimateOvulationDay(cycleStart, cycleLen, lutealDays) {\n  const len = cycleLen || 0;\n  if (!cycleStart) return '';\n  const d = len ? (len - lutealDays) : 0;\n  if (!d || d < 6 || d > 30) return '';\n  return addDaysStr(cycleStart, d);\n}\n\nexport default {\n  data() {\n    return {\n      cycleText: '',\n      prevCycleText: '',\n      riskTips: [],\n      riskHint: '',\n      trendSubText: '',\n      methodSubText: '',\n\n      metrics: {\n        totalThis: 0,\n        daysWith: 0,\n        avgText: '--',\n        maxGapText: '--'\n      },\n\n      trendDates: [],\n      trendLabels: [],\n      trendValues: [],\n\n      methodLegend: [],\n      recentList: [],\n\n      // tooltip\n      barTip: { show: false, left: 0, top: 0, date: '', value: 0 },\n\n      // canvas\n      canvasW: 1,\n      barH: 220,\n      pieH: 260\n    };\n  },\n\n  onLoad() {\n    this.refresh();\n  },\n  onShow() {\n    this.refresh();\n  },\n\n  methods: {\n    goAdd() {\n      // 你 addlove.vue 是按 date 展示/新增的（options.date）\n      // 这里默认跳到“今天”的记录页\n      const today = getTodayStr();\n      uni.navigateTo({ url: `/pages/subperiod/love/addlove?date=${encodeURIComponent(today)}` });\n    },\n\n    refresh() {\n      const store = normalizeStore(loadStore());\n      const settings = store.settings || DEFAULTS;\n\n      // 本周期范围：取最后一次经期 start 作为周期开始\n      const recordsAsc = store.periodRecords || [];\n      const cycleStart = recordsAsc.length ? (recordsAsc[recordsAsc.length - 1].start || '') : '';\n      const todayStr = getTodayStr();\n\n      // 周期长度：优先用两次 start 差值，否则用 settings\n      let cycleLen = 0;\n      if (recordsAsc.length >= 2) {\n        const prevStart = recordsAsc[recordsAsc.length - 2].start;\n        cycleLen = diffDays(prevStart, cycleStart);\n      }\n      if (!cycleLen) cycleLen = settings.cycleLength || DEFAULTS.cycleLength;\n\n      const cycleEnd = todayStr;\n\n      const ovulationDay = estimateOvulationDay(cycleStart, cycleLen, settings.lutealDays || DEFAULTS.lutealDays);\n      const fertileStart = ovulationDay ? addDaysStr(ovulationDay, -5) : '';\n      const fertileEnd = ovulationDay ? addDaysStr(ovulationDay, 1) : '';\n\n      // ✅ 不再使用 sexDates 兜底：只从 sexRecords 统计\n      const { entriesThis, totalThis, daysWith, unprotectedThis, fertileTimes } =\n        this.collectSexEntries(store.sexRecords, cycleStart, cycleEnd, fertileStart, fertileEnd);\n\n      const metrics = this.buildMetrics(cycleStart, cycleEnd, entriesThis);\n      metrics.totalThis = totalThis;\n      metrics.daysWith = daysWith;\n\n      const risk = this.buildRiskTips({\n        totalThis,\n        unprotectedThis,\n        fertileTimes,\n        hasFertile: !!ovulationDay,\n        fertileRangeText: ovulationDay ? `${fertileStart} ~ ${fertileEnd}` : ''\n      });\n\n      const trend = this.buildTrend30(store.sexRecords);\n      const method = this.buildMethodPie(entriesThis, totalThis);\n\n      const recentList = entriesThis\n        .slice()\n        .sort((a, b) => (b.date || '').localeCompare(a.date || ''))\n        .slice(0, 5)\n        .map((x) => ({\n          dateLabel: x.date,\n          time: x.time,\n          method: x.method\n        }));\n\n      const cycleText = cycleStart\n        ? `本周期范围：${cycleStart} ~ ${cycleEnd}（周期长度按 ${cycleLen} 天估算）`\n        : '暂无经期记录：本页将以“近30天趋势”为主展示';\n\n      const prevCycleText = ovulationDay\n        ? `排卵期（推算）：${fertileStart} ~ ${fertileEnd}`\n        : '';\n\n      this.setData({\n        metrics,\n        cycleText,\n        prevCycleText,\n        riskTips: risk.tips,\n        riskHint: risk.hint,\n        trendSubText: trend.subText,\n        methodSubText: method.subText,\n        trendDates: trend.dates,\n        trendLabels: trend.labels,\n        trendValues: trend.values,\n        methodLegend: method.legend,\n        recentList,\n        barTip: { show: false, left: 0, top: 0, date: '', value: 0 }\n      });\n\n      this.$nextTick(() => {\n        this.measureAndDrawBar(trend.dates, trend.labels, trend.values);\n        this.drawPie(method.slices);\n      });\n    },\n\n    inRange(ds, a, b) {\n      return ds && a && b && ds >= a && ds <= b;\n    },\n\n    // 只统计 sexRecords（每条记录都应该有 time + method）\n    collectSexEntries(sexRecords, rangeStart, rangeEnd, fertileStart, fertileEnd) {\n      const unprotectedRe = /(无措施|不避孕|未避孕|不使用|没用|无\\b)/;\n\n      const entries = [];\n      let total = 0;\n      const daysSet = new Set();\n      let unprotected = 0;\n      let fertileTimes = 0;\n\n      Object.keys(sexRecords || {}).forEach((ds) => {\n        if (rangeStart && rangeEnd && !this.inRange(ds, rangeStart, rangeEnd)) return;\n        const list = Array.isArray(sexRecords[ds]) ? sexRecords[ds] : [];\n        if (!list.length) return;\n\n        total += list.length;\n        daysSet.add(ds);\n\n        list.forEach((it) => {\n          const time = it && it.time ? String(it.time) : '--:--';\n          const method = it && it.method ? String(it.method).trim() : '未记录措施';\n          entries.push({ date: ds, time, method });\n\n          if (unprotectedRe.test(method)) unprotected += 1;\n          if (fertileStart && fertileEnd && this.inRange(ds, fertileStart, fertileEnd)) fertileTimes += 1;\n        });\n      });\n\n      return {\n        entriesThis: entries,\n        totalThis: total,\n        daysWith: daysSet.size,\n        unprotectedThis: unprotected,\n        fertileTimes\n      };\n    },\n\n    buildMetrics(cycleStart, cycleEnd, entriesThis) {\n      const totalDays = cycleStart ? (diffDays(cycleStart, addDaysStr(cycleEnd, 1)) || 0) : 0;\n\n      // 平均频率\n      let avgText = '--';\n      if (totalDays > 0) {\n        const perWeek = (entriesThis.length / totalDays) * 7;\n        avgText = `${perWeek.toFixed(1)}/周`;\n      } else {\n        avgText = entriesThis.length ? '—' : '--';\n      }\n\n      // 最长间隔（按发生日期）\n      let maxGapText = '--';\n      const dates = entriesThis.map(x => x.date).filter(Boolean);\n      const uniq = Array.from(new Set(dates)).sort();\n      if (uniq.length >= 2) {\n        let maxGap = 0;\n        for (let i = 1; i < uniq.length; i++) {\n          const gap = diffDays(uniq[i - 1], uniq[i]) - 1;\n          if (gap > maxGap) maxGap = gap;\n        }\n        maxGapText = maxGap === 0 ? '0天' : `${maxGap}天`;\n      } else if (uniq.length === 1) {\n        maxGapText = '—';\n      }\n\n      return { totalThis: 0, daysWith: 0, avgText, maxGapText };\n    },\n\n    buildRiskTips({ totalThis, unprotectedThis, fertileTimes, hasFertile, fertileRangeText }) {\n      const tips = [];\n\n      if (totalThis === 0) {\n        tips.push('本周期暂无爱爱记录：可以先记录一条，才会生成更准确的提示。');\n        return {\n          tips,\n          hint: '温馨提示：风险提示仅用于自我管理，不替代专业医疗建议。'\n        };\n      }\n\n      if (unprotectedThis > 0) {\n        tips.push(`存在 ${unprotectedThis} 次“无措施/未避孕”情况：如不计划怀孕，建议使用更可靠的避孕方式。`);\n      } else {\n        tips.push('避孕方式记录较规范：继续保持～');\n      }\n\n      if (hasFertile) {\n        tips.push(`排卵期（推算）：${fertileRangeText}。排卵期内记录次数：${fertileTimes} 次。`);\n        if (fertileTimes > 0 && unprotectedThis > 0) {\n          tips.push('若排卵期内存在未避孕情况，意外怀孕风险更高。');\n        }\n      } else {\n        tips.push('排卵期数据不足：需要更多经期记录才能进行推算。');\n      }\n\n      if (totalThis >= 10) {\n        tips.push('本周期次数较多：注意休息、清洁与舒适度；如有不适及时就医。');\n      }\n\n      return {\n        tips,\n        hint: '提示：排卵期为算法推算；如有备孕/避孕明确需求，建议结合更可靠方式或医生建议。'\n      };\n    },\n\n    // 近30天趋势：只用 sexRecords\n    buildTrend30(sexRecords) {\n      const today = new Date();\n      const dates = [];\n      const labels = [];\n\n      for (let i = 29; i >= 0; i--) {\n        const d = new Date(today);\n        d.setDate(d.getDate() - i);\n        const ds = toDateStr(d);\n        dates.push(ds);\n        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);\n      }\n\n      const values = dates.map((ds) => {\n        const list = Array.isArray((sexRecords || {})[ds]) ? (sexRecords || {})[ds] : [];\n        return list.length;\n      });\n\n      const total = values.reduce((a, b) => a + b, 0);\n      const max = Math.max(...values, 0);\n\n      const subText = total\n        ? `近30天共记录 ${total} 次 · 单日最高 ${max} 次`\n        : '近30天暂无记录';\n\n      return { dates, labels, values, subText };\n    },\n\n    // 措施分布饼图：按 method 归类\n    buildMethodPie(entriesThis, totalThis) {\n      const map = {};\n      const keyOf = (m) => {\n        const s = (m || '').trim();\n        if (!s) return '未记录措施';\n        return s;\n      };\n\n      entriesThis.forEach((it) => {\n        const k = keyOf(it.method);\n        map[k] = (map[k] || 0) + 1;\n      });\n\n      const arr = Object.keys(map).map(k => ({ k, v: map[k] }));\n      arr.sort((a, b) => b.v - a.v);\n\n      const top = arr.slice(0, 4);\n      const rest = arr.slice(4);\n      const restSum = rest.reduce((s, x) => s + x.v, 0);\n      if (restSum > 0) top.push({ k: '其他', v: restSum });\n\n      const palette = ['#ff6b9a', '#ff9f6b', '#6bc2ff', '#8d6bff', '#6bffb0'];\n\n      const slices = top.map((x, i) => ({\n        label: x.k,\n        value: x.v,\n        color: palette[i % palette.length]\n      }));\n\n      const legend = slices.map((s) => ({\n        label: s.label,\n        value: `${s.value}次`,\n        color: s.color\n      }));\n\n      const subText = totalThis ? `本周期共 ${totalThis} 次` : '本周期暂无记录';\n      this.setData({ methodSubText: subText });\n\n      return { slices, legend, subText };\n    },\n\n    // ====== Bar chart + Tooltip ======\n    measureAndDrawBar(dateStrs, labels, values) {\n      uni.createSelectorQuery()\n        .in(this)\n        .select('#barCanvas')\n        .boundingClientRect((rect) => {\n          if (!rect || !rect.width || !rect.height) return;\n\n          // 记录 canvas 在页面中的位置（用于 clientX/clientY 转换）\n          this._barRect = {\n            left: rect.left,\n            top: rect.top,\n            width: rect.width,\n            height: rect.height\n          };\n\n          const W = Math.max(1, Math.round(rect.width));\n          const H = Math.max(1, Math.round(rect.height));\n\n          this.setData({ canvasW: W, barH: H });\n\n          this.$nextTick(() => {\n            this.drawBar('barCanvas', W, H, dateStrs, labels, values);\n          });\n        })\n        .exec();\n    },\n\n    drawBar(canvasId, W, H, dateStrs, labels, values) {\n      const ctx = uni.createCanvasContext(canvasId, this);\n\n      // padding\n      const pL = 34;\n      const pR = 14;\n      const pT = 14;\n      const pB = 28;\n\n      const w = W - pL - pR;\n      const h = H - pT - pB;\n\n      ctx.clearRect(0, 0, W, H);\n      ctx.setFillStyle('#ffffff');\n      ctx.fillRect(0, 0, W, H);\n\n      const maxV = Math.max(...values, 0) || 1;\n\n      // 网格线（3条）\n      ctx.setStrokeStyle('rgba(0,0,0,0.06)');\n      ctx.setLineWidth(1);\n      for (let i = 1; i <= 3; i++) {\n        const y = pT + (h * i) / 3;\n        ctx.beginPath();\n        ctx.moveTo(pL, y);\n        ctx.lineTo(pL + w, y);\n        ctx.stroke();\n      }\n\n      // y轴最大值标注\n      ctx.setFillStyle('rgba(0,0,0,0.45)');\n      ctx.setFontSize(10);\n      ctx.fillText(`最大 ${maxV}`, 8, pT + 10);\n\n      // 柱子几何信息（用于点击命中）\n      const n = values.length;\n      const gap = 2;\n      const bw = Math.max(2, Math.floor((w - gap * (n - 1)) / n));\n\n      this._barGeom = { pL, pT, w, h, bw, gap, n };\n      this._barDates = dateStrs;\n      this._barValues = values;\n      this._barMaxV = maxV;\n\n      for (let i = 0; i < n; i++) {\n        const v = values[i] || 0;\n        const bh = Math.round((v / maxV) * h);\n        const x = pL + i * (bw + gap);\n        const y = pT + (h - bh);\n\n        ctx.setFillStyle(v > 0 ? 'rgba(255,107,154,0.85)' : 'rgba(0,0,0,0.06)');\n        ctx.fillRect(x, y, bw, bh);\n\n        // 横坐标：每 5 天一个 + 最后一天\n        if (i % 5 === 0 || i === n - 1) {\n          ctx.setFillStyle('rgba(0,0,0,0.45)');\n          ctx.setFontSize(10);\n          ctx.fillText(labels[i], x - 4, pT + h + 18);\n        }\n      }\n\n      ctx.draw();\n    },\n\n    // 兼容：小程序 touch.x/y、H5/App clientX/clientY\n    getCanvasPoint(e) {\n      const rect = this._barRect;\n      if (!rect) return null;\n\n      const t = (e && e.touches && e.touches[0]) ? e.touches[0] : null;\n      if (!t) return null;\n\n      // 微信小程序一般有 x/y（相对组件），也有 clientX/clientY（相对视口）\n      if (typeof t.x === 'number' && typeof t.y === 'number') {\n        return { x: t.x, y: t.y };\n      }\n\n      const cx = (typeof t.clientX === 'number') ? t.clientX : null;\n      const cy = (typeof t.clientY === 'number') ? t.clientY : null;\n      if (cx == null || cy == null) return null;\n\n      return { x: cx - rect.left, y: cy - rect.top };\n    },\n\n    onBarTouch(e) {\n      const p = this.getCanvasPoint(e);\n      if (!p || !this._barGeom) return;\n\n      const x = p.x;\n      const y = p.y;\n\n      const { pL, pT, w, h, bw, gap, n } = this._barGeom;\n\n      // 点击到绘图区外：隐藏 tooltip\n      if (x < pL || x > pL + w || y < pT || y > pT + h) {\n        this.setData({ barTip: { show: false, left: 0, top: 0, date: '', value: 0 } });\n        return;\n      }\n\n      // 命中柱子索引\n      const idx = Math.floor((x - pL) / (bw + gap));\n      if (idx < 0 || idx >= n) return;\n\n      const date = this._barDates && this._barDates[idx] ? this._barDates[idx] : '';\n      const value = this._barValues && typeof this._barValues[idx] === 'number' ? this._barValues[idx] : 0;\n\n      // tooltip 位置（尽量贴近柱顶，不出边界）\n      let left = pL + idx * (bw + gap) + bw / 2 - 46;\n      if (left < 6) left = 6;\n      if (left > this.canvasW - 92) left = this.canvasW - 92;\n\n      const maxV = this._barMaxV || 1;\n      const bh = Math.round((value / maxV) * h);\n      const barTop = pT + (h - bh);\n\n      let top = barTop - 44;\n      if (top < 6) top = 6;\n\n      this.setData({\n        barTip: {\n          show: true,\n          left: Math.round(left),\n          top: Math.round(top),\n          date,\n          value\n        }\n      });\n    },\n\n    // ====== Pie chart ======\n    drawPieImpl(canvasId, W, H, slices) {\n      const ctx = uni.createCanvasContext(canvasId, this);\n      ctx.clearRect(0, 0, W, H);\n\n      ctx.setFillStyle('#ffffff');\n      ctx.fillRect(0, 0, W, H);\n\n      const cx = Math.round(W / 2);\n      const cy = Math.round(H / 2) - 6;\n      const r = Math.min(W, H) * 0.32;\n      const inner = r * 0.55;\n\n      const total = slices.reduce((s, x) => s + (x.value || 0), 0) || 1;\n      let start = -Math.PI / 2;\n\n      slices.forEach((s) => {\n        const ang = (s.value / total) * Math.PI * 2;\n        const end = start + ang;\n\n        ctx.beginPath();\n        ctx.moveTo(cx, cy);\n        ctx.arc(cx, cy, r, start, end);\n        ctx.closePath();\n        ctx.setFillStyle(s.color);\n        ctx.fill();\n\n        start = end;\n      });\n\n      // 中空\n      ctx.beginPath();\n      ctx.arc(cx, cy, inner, 0, Math.PI * 2);\n      ctx.setFillStyle('#ffffff');\n      ctx.fill();\n\n      // 中间文字\n      ctx.setFillStyle('rgba(0,0,0,0.65)');\n      ctx.setFontSize(12);\n      ctx.fillText('本周期', cx - 16, cy - 2);\n      ctx.setFontSize(12);\n      ctx.fillText(`${total} 次`, cx - 14, cy + 16);\n\n      ctx.draw();\n    },\n\n    drawPie(slices) {\n      uni.createSelectorQuery()\n        .in(this)\n        .select('#pieCanvas')\n        .boundingClientRect((rect) => {\n          if (!rect || !rect.width || !rect.height) return;\n\n          const W = Math.max(1, Math.round(rect.width));\n          const H = Math.max(1, Math.round(rect.height));\n\n          this.setData({ canvasW: W, pieH: H });\n\n          this.$nextTick(() => {\n            this.drawPieImpl('pieCanvas', W, H, slices || []);\n          });\n        })\n        .exec();\n    }\n  }\n};\n</script>\n\n<style src=\"./love.css\"></style>\n\n<style>\n/* tooltip 补丁样式：不影响你原 love.css */\n.chart-wrap{ position: relative; }\n.bar-tip{\n  position: absolute;\n  width: 92px;\n  padding: 6px 8px;\n  border-radius: 10px;\n  background: rgba(168, 168, 168, 0.7);\n  box-sizing: border-box;\n}\n.bar-tip-date{\n  display: block;\n  font-size: 11px;\n  color: rgba(255,255,255,0.92);\n}\n.bar-tip-val{\n  display: block;\n  margin-top: 2px;\n  font-size: 12px;\n  font-weight: 700;\n  color: #ffffff;\n}\n</style>\n","import mod from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./love.vue?vue&type=style&index=1&lang=css&\"; export default mod; export * from \"-!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/loader.js??ref--6-oneOf-1-0!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/css-loader/dist/cjs.js??ref--6-oneOf-1-1!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/stylePostLoader.js!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--6-oneOf-1-2!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/postcss-loader/src/index.js??ref--6-oneOf-1-3!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../Programming/HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./love.vue?vue&type=style&index=1&lang=css&\"","// extracted by mini-css-extract-plugin\n    if(module.hot) {\n      // 1768876148515\n      var cssReload = require(\"D:/Programming/HBuilderX/plugins/uniapp-cli/node_modules/mini-css-extract-plugin/dist/hmr/hotModuleReplacement.js\")(module.id, {\"hmr\":true,\"publicPath\":\"/\",\"locals\":false});\n      module.hot.dispose(cssReload);\n      module.hot.accept(undefined, cssReload);\n    }\n  "],"sourceRoot":""}